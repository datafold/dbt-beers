kind: pipeline
name: default

steps:
  - name: dbt
    image: fishtownanalytics/dbt:0.19.1
    volumes:
      - name: secrets
        path: /secrets/
    commands:
      - mkdir -p /tmp/gcloud/
      - printf '%s' "$GOOGLE_APPLICATION_CREDENTIALS" > /tmp/gcloud/cert.json
      - apt-get update -qq && apt-get install -qq -y apt-transport-https ca-certificates gnupg curl
      - echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list && curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg  add - && apt-get update -qq -y && apt-get -qq install -y google-cloud-sdk
      - gcloud auth activate-service-account --key-file=/tmp/gcloud/cert.json
      - dbt run --profiles-dir=`pwd`
      - rm -rf /tmp/gcloud/
    environment:
      GOOGLE_APPLICATION_CREDENTIALS:
        from_secret: google_application_credentials
  - name: data-diff
    image: python:3.8

---
kind: secret
name: google_application_credentials
data: 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
